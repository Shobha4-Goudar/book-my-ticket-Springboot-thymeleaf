<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Manage Users - BookMyTicket</title>

	<!-- Bootstrap -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

	<!-- Google Font -->
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

	<style>
		:root{
			--bg: #0d0d0d;
			--card-bg: rgba(20,20,20,0.65);
			--muted: #b3b3b3;
			--accent1: #ff3c3c;
			--accent2: #ff7b3c;
			--glass-border: rgba(255,255,255,0.06);
		}

		*{ box-sizing: border-box; margin:0; padding:0; }
		body {
			font-family: 'Poppins', sans-serif;
			background: var(--bg);
			color: #fff;
			min-height: 100vh;
			-webkit-font-smoothing:antialiased;
		}

		/* NAVBAR */
		.navbar {
			background: rgba(0,0,0,0.85) !important;
			backdrop-filter: blur(8px);
			padding: 1rem 2rem;
			border-bottom: 1px solid rgba(255,255,255,0.02);
		}
		.navbar-brand { font-weight:600; font-size:1.6rem; }
		.navbar .btn-danger { background: linear-gradient(45deg, #ff3c3c, #ff7b3c); border:none; }
		.navbar .btn-primary { background: #0b67ff; border:none; }

		/* HERO */
		.hero {
			background: url('https://images.unsplash.com/photo-1524985069026-dd778a71c7b4?auto=format&fit=crop&w=1600&q=80') center/cover no-repeat;
			padding: 140px 0 70px 0;
			position: relative;
			text-align: center;
			color: #fff;
			margin-bottom: 30px;
			border-bottom: 2px solid rgba(255,255,255,0.03);
		}
		.hero::after {
			content: "";
			position: absolute;
			inset: 0;
			background: linear-gradient(180deg, rgba(0,0,0,0.55) 0%, rgba(0,0,0,0.68) 100%);
		}
		.hero .container { position: relative; z-index:2; }
		.hero h1 { font-size: 2.6rem; font-weight:700; margin-bottom:8px; }
		.hero p { color: var(--muted); margin-bottom:16px; }

		/* MAIN CONTAINER */
		.admin-container {
			max-width: 1100px;
			margin: -40px auto 60px;
			padding: 24px;
		}

		.header-row {
			display:flex;
			justify-content:space-between;
			align-items:center;
			gap:12px;
			margin-bottom:18px;
		}
		.header-row h2 { margin:0; font-size:1.4rem; font-weight:700; color:#fff; }
		.header-actions { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

		.search-input {
			width:320px;
			max-width:100%;
		}

		/* TABLE CARD (glass) */
		.table-wrapper {
			background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
			border-radius: 12px;
			border: 1px solid var(--glass-border);
			overflow: hidden;
			padding: 12px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.6);
			backdrop-filter: blur(6px);
		}

		table {
			width:100%;
			border-collapse: collapse;
			color:#fff;
		}

		thead th {
			text-align:left;
			padding:14px 12px;
			font-weight:600;
			font-size:0.85rem;
			color:#fff;
			border-bottom: 1px solid rgba(255,255,255,0.03);
			text-transform:uppercase;
			letter-spacing:0.6px;
		}

		tbody td {
			padding:12px;
			vertical-align: middle;
			color: #eaeaea;
			border-bottom: 1px solid rgba(255,255,255,0.02);
			font-weight:500;
		}

		.user-name { color:#fff; font-weight:700; }
		.user-email, .user-mobile { color: var(--muted); font-size:0.9rem; }

		.action-cell { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

		.btn-block, .btn-unblock {
			padding:8px 14px;
			border-radius:10px;
			font-weight:600;
			font-size:0.85rem;
			border:none;
			cursor:pointer;
			text-decoration:none;
			display:inline-flex;
			align-items:center;
			justify-content:center;
		}

		.btn-block {
			background: linear-gradient(45deg, var(--accent1), var(--accent2));
			color:#fff;
		}
		.btn-unblock {
			background: linear-gradient(45deg, #26c281, #27ae60);
			color:#fff;
		}
		.btn-delete {
			background: transparent;
			color:#ff6b6b;
			border: 1px solid rgba(255,107,107,0.12);
		}

		.status-badge {
			padding:6px 10px;
			border-radius:999px;
			font-weight:700;
			font-size:0.75rem;
		}
		.badge-active { background: rgba(38,194,129,0.12); color:#26c281; }
		.badge-blocked { background: rgba(255,64,129,0.08); color:#ff6b8a; }

		/* Empty state */
		.empty-state { padding:40px; text-align:center; color:var(--muted); }

		/* Toastify */
		.toastify-container {
			position: fixed;
			top: 1rem;
			right: 1rem;
			z-index: 99999;
		}
		.toastify {
			min-width: 280px;
			border-radius: 8px;
			padding: 14px 18px;
			color: white;
			font-weight: 500;
			display:flex;
			align-items:center;
			gap:12px;
			box-shadow: 0 6px 20px rgba(0,0,0,0.25);
			opacity: 0;
			transform: translateX(120%);
			animation: slideIn 0.4s forwards, fadeOut 0.4s 3s forwards;
			position: relative;
		}
		.toastify.success { background: #2ecc71; }
		.toastify.error { background: #e74c3c; }
		.toastify::after {
			content: "";
			position: absolute;
			left: 0;
			bottom: 0;
			height: 4px;
			background: rgba(255,255,255,0.7);
			animation: progressBar 3s linear forwards;
		}

		@keyframes slideIn { to { opacity:1; transform: translateX(0); } }
		@keyframes fadeOut { to { opacity:0; transform: translateX(120%); } }
		@keyframes progressBar { from { width:100%; } to { width:0%; } }

		/* Responsive */
		@media (max-width: 768px) {
			.header-row { flex-direction:column; align-items:flex-start; gap:12px; }
			.search-input { width:100%; }
			.admin-container { margin-top: -20px; padding: 14px; }
			.movie-grid { grid-template-columns: repeat(1,1fr); }
			.table-wrapper { padding:10px; }
		}
	</style>
</head>
<body>

	<!-- NAVBAR -->
	<nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
		<div class="container-fluid">
			<a class="navbar-brand" href="/">üé¨ BookMyTicket</a>
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
				<span class="navbar-toggler-icon"></span>
			</button>

			<div id="navMenu" class="collapse navbar-collapse justify-content-end">
				<!-- NOT LOGGED IN -->
				<div th:if="${session.user == null}">
					<a href="/login" class="btn btn-outline-light me-2">Login</a>
					<a href="/register" class="btn btn-warning">Register</a>
				</div>

				<!-- LOGGED IN -->
				<div th:if="${session.user != null}" class="d-flex align-items-center">
					<span class="text-white me-3 fw-semibold" th:text="'Hello, ' + ${session.user.name}"></span>
					<a th:if="${session.user.role==USER}" href="/bookings" class="btn btn-outline-light me-2">My Bookings</a>
					<a th:if="${session.user.role==USER}" href="/movies" class="btn btn-outline-light me-2">Movies</a>
					<a th:if="${session.user.role==ADMIN}" href="/manage-movies" class="btn btn-danger me-2">Manage Movies</a>
					<a th:if="${session.user.role==ADMIN}" href="/manage-screens" class="btn btn-danger me-2">Manage Screens</a>
					<a th:if="${session.user.role==ADMIN}" href="/manage-users" class="btn btn-danger me-2">Manage Users</a>
					<a href="/logout" class="btn btn-primary">Logout</a>
				</div>
			</div>
		</div>
	</nav>

	<!-- TOASTS -->
	<div class="toastify-container">
		<div th:if="${pass}" class="toastify success">
			<span th:text="${pass}"></span>
		</div>
		<div th:if="${fail}" class="toastify error">
			<span th:text="${fail}"></span>
		</div>
	</div>

	<!-- HERO -->
	<section class="hero">
		<div class="container">
			<h1>Manage Users</h1>
			<p>View, block/unblock and manage all registered users on the platform</p>
		</div>
	</section>

	<!-- MAIN -->
	<div class="admin-container container">

		<div class="header-row">
			<h2>üë• Users</h2>
			<div class="header-actions">
				<input id="searchInput" type="text" class="form-control search-input" placeholder="Search by name, email or mobile...">
				<a href="/" class="btn btn-outline-light">‚Üê Back to Home</a>
			</div>
		</div>

		<!-- TABLE -->
		<div th:if="${users != null && users.size() > 0}" class="table-wrapper">
			<table>
				<thead>
					<tr>
						<th>Name</th>
						<th>Email</th>
						<th>Mobile</th>
						<th>Status</th>
						<th>Action</th>
					</tr>
				</thead>
				<tbody id="usersTableBody">
					<tr th:each="user : ${users}">
						<td>
							<span class="user-name" th:text="${user.name}">User Name</span>
						</td>
						<td>
							<span class="user-email" th:text="${user.email}">email@example.com</span>
						</td>
						<td>
							<span class="user-mobile" th:text="${user.mobile}">9999999999</span>
						</td>
						<td>
							<span th:if="${!user.blocked}" class="status-badge badge-active">Active</span>
							<span th:if="${user.blocked}" class="status-badge badge-blocked">Blocked</span>
						</td>
						<td>
							<div class="action-cell">
								<!-- Block / Unblock with confirmation -->
								<a th:if="${!user.blocked}" th:href="'/block/'+${user.id}" class="btn-block"
								   onclick="return confirmAction(event, 'block', [[$.{user.name}]])">Block</a>

								<a th:if="${user.blocked}" th:href="'/un-block/'+${user.id}" class="btn-unblock"
								   onclick="return confirmAction(event, 'unblock', [[${user.name}]])">Unblock</a>

								<!-- Optional delete (uncomment if supported) -->
								<!--
								<form th:action="'/delete-user/'+${user.id}" method="post" th:onsubmit="return confirm('Delete this user?');">
									<button type="submit" class="btn btn-sm btn-delete">Delete</button>
								</form>
								-->
							</div>
						</td>
					</tr>
				</tbody>
			</table>

			<!-- PAGINATION PLACEHOLDER: replace with your Thymeleaf paging controls -->
			<div class="d-flex justify-content-between align-items-center mt-3">
				<div class="text-muted small">Showing <span th:text="${users.size()}">0</span> users</div>
				<nav aria-label="Page navigation">
					<ul class="pagination pagination-sm mb-0">
						<li class="page-item"><a class="page-link" href="#">Previous</a></li>
						<li class="page-item"><a class="page-link" href="#">1</a></li>
						<li class="page-item"><a class="page-link" href="#">2</a></li>
						<li class="page-item"><a class="page-link" href="#">Next</a></li>
					</ul>
				</nav>
			</div>
		</div>

		<!-- EMPTY STATE -->
		<div th:if="${users == null || users.size() == 0}" class="empty-state table-wrapper">
			<div style="padding:40px;">
				<div style="font-size:48px; margin-bottom:12px;">üì≠</div>
				<h4 style="color:#fff; margin-bottom:8px;">No users found</h4>
				<p style="color:var(--muted); margin-bottom:16px;">There are no registered users yet.</p>
				<a href="/" class="btn btn-outline-light">Go to Home</a>
			</div>
		</div>
	</div>

	<!-- FOOTER -->
	<footer class="text-center text-muted" style="padding:20px 0; border-top:1px solid rgba(255,255,255,0.03);">
		<p style="margin:0;">¬© 2025 BookMyTicket ‚Äî All Rights Reserved</p>
	</footer>

	<!-- Bootstrap JS -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

	<script>
		// Confirm action (block/unblock) with nicer message
		function confirmAction(event, action, userName) {
			// If Thymeleaf expression replacement returns undefined, fallback to generic string
			userName = (typeof userName !== 'undefined' && userName != null) ? userName : 'this user';
			const verb = (action === 'block') ? 'block' : 'unblock';
			const confirmed = confirm(`Are you sure you want to ${verb} ${userName}?`);
			if (!confirmed) {
				event.preventDefault();
			}
			return confirmed;
		}

		// Toast close buttons & auto remove (same style as main)
		document.addEventListener("DOMContentLoaded", () => {
			const toasts = document.querySelectorAll('.toastify');

			toasts.forEach(toastElement => {
				// create close button
				const closeBtn = document.createElement('button');
				closeBtn.className = 'toastify-close';
				closeBtn.innerHTML = '√ó';
				closeBtn.type = 'button';
				closeBtn.style.cssText = "position:absolute;right:8px;top:8px;background:rgba(255,255,255,0.12);border:none;color:white;border-radius:50%;width:28px;height:28px;font-size:16px;cursor:pointer;";

				const spanElement = toastElement.querySelector('span');
				if (spanElement) {
					toastElement.insertBefore(closeBtn, spanElement.nextSibling);
				}

				closeBtn.addEventListener('click', () => {
					toastElement.style.animation = 'fadeOut 0.4s forwards';
					setTimeout(() => toastElement.remove(), 400);
				});

				const timeout = setTimeout(() => {
					if (document.body.contains(toastElement)) {
						toastElement.style.animation = 'fadeOut 0.4s forwards';
						setTimeout(() => toastElement.remove(), 400);
					}
				}, 3500);

				closeBtn.addEventListener('click', () => clearTimeout(timeout));
			});
		});

		// Client-side search for quick filtering
		(function () {
			const input = document.getElementById('searchInput');
			if (!input) return;
			input.addEventListener('keyup', function () {
				const q = this.value.trim().toLowerCase();
				const rows = document.querySelectorAll('#usersTableBody tr');
				if (!rows) return;
				rows.forEach(row => {
					const text = row.innerText.toLowerCase();
					row.style.display = text.includes(q) ? '' : 'none';
				});
			});
		});
	</script>
</body>
</html>
